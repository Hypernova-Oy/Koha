[% USE raw %]
[% USE Asset %]
[% USE Branches %]
[% USE Price %]
[% USE Koha %]
[% PROCESS 'i18n.inc' %]
[% SET footerjs = 1 %]
[% INCLUDE 'doc-head-open.inc' %]
<title>[% FILTER collapse %]
 [% tx("Basket grouping for '{vendor}'", { vendor = booksellername }) %] &rsaquo;
 [% t("Koha") | html %]
[% END %]</title>
[% INCLUDE 'doc-head-close.inc' %]
</head>

<body id="acq_basketgroup" class="acq">
[% WRAPPER 'header.inc' %]
 [% INCLUDE 'acquisitions-search.inc' %]
[% END %]

[% WRAPPER 'sub-header.inc' %]
 [% WRAPPER breadcrumbs %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/acqui/acqui-home.pl">Inköp</a>
 [% END %]
 [% IF ( grouping ) %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/acqui/supplier.pl?booksellerid=[% booksellerid | uri %]">[% booksellername | html %]</a>
 [% END %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/acqui/basketgroup.pl?booksellerid=[% booksellerid | uri %]">Korggruppering</a>
 [% END %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>Lägg till korggrupp för [% booksellername | html %]</span>
 [% END %]
 [% ELSE %]
 [% WRAPPER breadcrumb_item %]
 <a href="/cgi-bin/koha/acqui/supplier.pl?booksellerid=[% booksellerid | uri %]">[% booksellername | html %]</a>
 [% END %]
 [% WRAPPER breadcrumb_item bc_active= 1 %]
 <span>Korggruppering</span>
 [% END %]
 [% END  # /IF grouping %]
 [% END #/ WRAPPER breadcrumbs %]
[% END #/ WRAPPER sub-header.inc %]

<div class="main container-fluid">
 <div class="row">
 <div class="col-md-10 order-md-2 order-sm-2">
 <main>
 [% INCLUDE 'messages.inc' %]

 [% IF ( grouping ) %]
 [% IF (closedbg) %]
 <div id="toolbar" class="btn-toolbar">
 <div class="btn-group"><a href="/cgi-bin/koha/acqui/basketgroup.pl?op=reopen&amp;basketgroupid=[% basketgroupid | uri %]&amp;booksellerid=[% booksellerid | uri %]&amp;mode=singlebg" class="btn btn-default" id="reopenbutton"><i class="fa fa-download"></i> Öppna korggrupp igen</a></div>
 <div class="btn-group"><a href="/cgi-bin/koha/acqui/basketgroup.pl?op=export&amp;basketgroupid=[% basketgroupid | uri %]&amp;booksellerid=[% booksellerid | uri %]" class="btn btn-default" id="exportbutton"><i class="fa fa-download"></i> Exportera denna korggrupp som CSV</a></div>
 <div class="btn-group"><a href="/cgi-bin/koha/acqui/basketgroup.pl?op=print&amp;basketgroupid=[% basketgroupid | uri %]&amp;booksellerid=[% booksellerid | uri %]" class="btn btn-default" id="printbutton"><i class="fa fa-download"></i> Skriv ut denna korggrupp som PDF</a></div>
 [% IF (ediaccount) %]
 <div class="btn-group"><a href="/cgi-bin/koha/acqui/basketgroup.pl?op=ediprint&amp;basketgroupid=[% basketgroupid | uri %]&amp;booksellerid=[% booksellerid | uri %]" class="btn btn-default" id="printbutton"><i class="fa fa-download"></i> Skapa EDIFACT-beställning</a></div>
 [% END %]
 </div>
 [% END %]
 [% IF (name && closedbg) %]
 <h1>Korggrupp [% name | html %] ([% basketgroupid | html %]) för <a href="/cgi-bin/koha/acqui/supplier.pl?booksellerid=[% booksellerid | uri %]">[% booksellername | html %]</a></h1>
 [% ELSIF (name) %]
 <h1>Redigera korggrupp [% name | html %] ([% basketgroupid | html %]) för <a href="/cgi-bin/koha/acqui/supplier.pl?booksellerid=[% booksellerid | uri %]">[% booksellername | html %]</a></h1>
 [% ELSE %]
 <h1>Lägg till korggrupp för <a href="/cgi-bin/koha/acqui/supplier.pl?booksellerid=[% booksellerid | uri %]">[% booksellername | html %]</a></h1>
 [% END %]
 <div id="basketgroupcolumns" class="row">
 [% UNLESS (closedbg) %]
 <div class="col-sm-6 order-sm-2">
 <div id="groups">
 <div class="workarea_alt" >
 <h3>Korgar som inte tillhör grupper</h3>
 <div class="page-section">
 <table id="ungrouped" class="basketgroup_baskets">
 <thead>
 <tr>
 <th>Korg</th>
 <th>Totalt</th>
 <th class="NoSort"></th>
 </tr>
 </thead>
 <tbody>
 [% IF ( baskets ) %]
 [% FOREACH basket IN baskets %]
 <tr class="ungrouped" id="b-[% basket.basketno | html %]">
 <td>
 <a href="basket.pl?basketno=[% basket.basketno | uri %]">
 [% IF ( basket.basketname ) %]
 [% basket.basketname | html %]
 [% ELSE %]
 <span>Inget namn, korgnummer: [% basket.basketno | html %]</span>
 [% END %]
 </a>
 </td>
 <td data-sort="[% basket.total | html %]">
 [% basket.total | $Price %]
 <input type="hidden" class="basket" name="basket" value="[% basket.basketno | html %]" />
 </td>
 <td>
 <a class="addtogroup btn btn-default btn-xs" data-basketid="b-[% basket.basketno | html %]">
 <i class="fa fa-plus" aria-hidden="true"></i> Lägg till i grupp </a>
 </td>
 </tr>
 [% END %]
 [% END %]
 </tbody>
 </table>
 </div><!--/.page-section -->
 </div> <!-- /.workarea_alt -->
 </div><!-- /#groups -->
 </div><!-- /.col.order-2 -->
 [% END %]
 [% IF ( closedbg ) %]
 <div class="col">
 [% ELSE %]
 <div class="col-sm-6 order-sm-1">
 [% END %]
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="post" id="groupingform">
 [% INCLUDE 'csrf-token.inc' %]
 <fieldset id="various" class="brief">
 <ol>
 [% UNLESS (closedbg) %]
 <li>
 <label for="basketgroupname">Namn på korggrupp:</label>
 <input type="text" name="basketgroupname" id="basketgroupname" value="[% name | html %]" class="focus" />
 </li>
 [% ELSE %]
 <input type="hidden" name="basketgroupname" id="basketgroupname" value="[% name | html %]" />
 [% END %]
 <li>
 [% UNLESS (closedbg) %]
 <label for="billingplace">Faktureringsplats:</label>
 <select name="billingplace" id="billingplace">
 <option value="">--</option>
 [% PROCESS options_for_libraries libraries => Branches.all( selected => billingplace ) %]
 </select>
 [% ELSE %]
 <span class="label">Faktureringsplats:</span>
 <input name="billingplace" id="billingplace" type ="hidden" value="[% billingplace | html %]" />[% Branches.GetName( billingplace ) | html %]
 [% END %]
 </li>
 [% UNLESS (closedbg) %]
 <li>
 <label for="deliveryplace">Leveransplats:</label>
 <select name="deliveryplace" id="deliveryplace">
 <option value="">--</option>
 [% PROCESS options_for_libraries libraries => Branches.all( selected => deliveryplace ) %]
 </select>
 </li>
 </ol>
 <p>eller</p>
 <ol>
 <li>
 <label for="freedeliveryplace">Leveransplats:</label>
 <textarea cols="26" rows="3" name="freedeliveryplace" id="freedeliveryplace">[% freedeliveryplace | html %]</textarea>
 </li>
 [% ELSE %]
 <li>
 <span class="label">Leveransplats:</span>
 [% IF (freedeliveryplace) %]
 <input name="freedeliveryplace" id="freedeliveryplace" type ="hidden" value="[% freedeliveryplace | html %]" />[% freedeliveryplace | html %]
 <input name="deliveryplace" id="deliveryplace" type ="hidden" value="" />
 [% ELSE %]
 <input name="deliveryplace" id="deliveryplace" type ="hidden" value="[% deliveryplace | html %]" />[% Branches.GetName( deliveryplace ) | html %]
 <input name="freedeliveryplace" id="freedeliveryplace" type ="hidden" value="" />
 [% END %]
 </li>
 [% END %]
 <li>
 [% UNLESS (closedbg) %]
 <label for="deliverycomment">Leveranskommentar:</label>
 <textarea cols="26" rows="3" name="deliverycomment" id="deliverycomment">[% deliverycomment | html %]</textarea>
 [% ELSE %]
 <span class="label">Leveranskommentar:</span>[% deliverycomment | html %]
 <input name="deliverycomment" id="deliverycomment" type="hidden" value = "[% deliverycomment | html %]" />
 [% END %]
 </li>
 </ol>
 <h3>Korgar i denna grupp:</h3>
 <table id="grouped" class="basketgroup_baskets">
 <thead>
 <tr>
 <th>Korg</th>
 <th>Totalt</th>
 <th class="NoSort"></th>
 </tr>
 </thead>
 <tbody>
 [% FOREACH selectedbasket IN selectedbaskets %]
 <tr id="b-[% selectedbasket.basketno | html %]">
 <td>
 <a href="basket.pl?basketno=[% selectedbasket.basketno | uri %]">
 [% IF ( selectedbasket.basketname ) %]
 [% selectedbasket.basketname | html %]
 [% ELSE %]
 <span>Inget namn, korgnummer: [% selectedbasket.basketno | html %]</span>
 [% END %]
 </a>
 </td>
 <td data-sort="[% selectedbasket.total | html %]">
 [% selectedbasket.total | $Price %]
 <input type="hidden" class="basket" name="basket" value="[% selectedbasket.basketno | html %]" />
 </td>
 <td>
 [% IF ( closedbg ) %]
 [% ELSE %]
 <a class="removefromgroup btn btn-default btn-xs" data-basketid="b-[% selectedbasket.basketno | html %]" id="addtogroup[% selectedbasket.basketno | html %]">
 <i class="fa fa-trash-can" aria-hidden="true"></i> Ta bort </a>
 [% END %]
 </td>
 </tr>
 [% END %]
 </tbody>
 </table>
 [% UNLESS (closedbg) %]
 <ol>
 <li><label for="closedbg">Stäng korggrupp</label><input type="checkbox" id="closedbg" name="closedbg" /></li>
 </ol>
 [% ELSE %]
 <input type="hidden" id="closedbg" name="closedbg" value ="1"/>
 [% END %]
 </fieldset>

 [% UNLESS (closedbg) %]
 <fieldset class="action"><input type="hidden" name="booksellerid" value="[% booksellerid | html %]" />
 [% IF ( basketgroupid ) %]
 <input type="hidden" name="basketgroupid" value="[% basketgroupid | html %]" />
 [% END %]
 <input type="hidden" name="op" value="cud-attachbasket" />
 <input class="btn btn-primary" type="submit" value="Spara" /> <a href="/cgi-bin/koha/acqui/basketgroup.pl?booksellerid=[% booksellerid | uri %]" class="cancel">Avbryt</a>
 </fieldset>
 [% END %]
 </form>
 </div> <!-- /.col -->
 </div> <!-- /#basketgroupcolumns.row -->
 [% ELSE %]
 <div id="toolbar" class="btn-toolbar">
 <div class="btn-group"><a href="/cgi-bin/koha/acqui/basketgroup.pl?op=add_form&amp;booksellerid=[% booksellerid | uri %]" class="btn btn-default" id="newbasketgroup"><i class="fa fa-plus"></i> Ny korggrupp</a></div>
 </div>
 <h1>Korggruppering för <a href="/cgi-bin/koha/acqui/supplier.pl?booksellerid=[% booksellerid | uri %]">[% booksellername | html %]</a></h1>
 [% IF (NoEDIMessage && Koha.Preference('EDIFACT')) %]<div><strong>Ingen EDIFACT konfiguration för [% booksellername | html %]</strong></div>[% END %]

 [% WRAPPER tabs id= "basket_groups" %]
 [% WRAPPER tabs_nav %]
 [% WRAPPER tab_item tabname= "opened" bt_active= 1 %] <span>Öppna</span> [% END %]
 [% WRAPPER tab_item tabname= "closed" %] <span>Stängda</span> [% END %]
 [% END %]
 [% WRAPPER tab_panels %]
 [% WRAPPER tab_panel tabname="opened" bt_active= 1 %]
 <table id="basket_group_opened">
 <thead>
 <tr>
 <th>Namn</th>
 <th>Antal</th>
 <th>Faktureringsplats</th>
 <th>Leveransplats</th>
 <th>Antal korgar</th>
 <th>Åtgärd</th>
 </tr>
 </thead>
 <tbody>
 [% FOREACH basketgroup IN basketgroups %]
 [% UNLESS ( basketgroup.closed ) %]
 <tr>
 <td>
 [% IF ( basketgroup.name ) %]
 [% basketgroup.name | html %]
 [% ELSE %]
 <span>Korggrupp nummer [% basketgroup.id | html %]</span>
 [% END %]
 </td>
 <td>[% basketgroup.id | html %]</td>
 <td>[% Branches.GetName( basketgroup.billingplace ) | html %]</td>
 <td>[% IF (basketgroup.freedeliveryplace) %]Plats för fri leverans[% ELSE %][% Branches.GetName( basketgroup.deliveryplace ) | html %][% END %]</td>
 <td>[% basketgroup.basketsqty | html %]</td>
 <td>
 <input data-basketgroupid="[% basketgroup.id | html %]" id="close_and_print" type="button" value="Stäng och exportera som PDF" />
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="get">
 <input type="hidden" name="op" value="add_form" />
 <input type="hidden" name="booksellerid" value="[% basketgroup.booksellerid | html %]" />
 <input type="hidden" name="basketgroupid" value="[% basketgroup.id | html %]" />
 <input class="btn btn-primary" type="submit" value="Redigera" />
 </form>
 [% UNLESS basketgroup.basketsqty %]
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="post">
 <input type="hidden" name="op" value="cud-delete" />
 <input type="hidden" name="booksellerid" value="[% basketgroup.booksellerid | html %]" />
 <input type="hidden" name="basketgroupid" value="[% basketgroup.id | html %]" />
 <input class="btn btn-primary" id="delete_basketgroup" type="submit" value="Ta bort" />
 [% INCLUDE 'csrf-token.inc' %]
 </form>
 [% END %]
 </td>
 </tr>
 [% END %]
 [% END %]
 </tbody>
 </table>
 [% END #/opened %]

 [% WRAPPER tab_panel tabname="closed" %]
 <table id="basket_group_closed">
 <thead>
 <tr>
 <th>Namn</th>
 <th>Antal</th>
 <th>Faktureringsplats</th>
 <th>Leveransplats</th>
 <th>Antal korgar</th>
 <th>Åtgärd</th>
 </tr>
 </thead>
 <tbody>
 [% FOREACH basketgroup IN basketgroups %]
 [% IF ( basketgroup.closed ) %]
 <tr>
 <td>
 [% IF ( basketgroup.name ) %]
 [% basketgroup.name | html %]
 [% ELSE %]
 <span>Korggrupp nummer [% basketgroup.id | html %]</span>
 [% END %]
 </td>
 <td>[% basketgroup.id | html %]</td>
 <td>[% Branches.GetName( basketgroup.billingplace ) | html %]</td>
 <td>[% IF (basketgroup.freedeliveryplace) %]Plats för fri leverans[% ELSE %][% Branches.GetName( basketgroup.deliveryplace ) | html %][% END %]</td>
 <td>[% basketgroup.basketsqty | html %]</td>
 <td>
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="get"><input type="hidden" name="op" value="add_form" /><input type="hidden" name="booksellerid" value="[% basketgroup.booksellerid | html %]" /><input type="hidden" name="basketgroupid" value="[% basketgroup.id | html %]" /><input class="btn btn-primary" type="submit" value="Visa" /></form>
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="post"><input type="hidden" name="op" value="cud-reopen" /><input type="hidden" name="booksellerid" value="[% basketgroup.booksellerid | html %]" /><input type="hidden" name="basketgroupid" value="[% basketgroup.id | html %]" /><input class="btn btn-primary" type="submit" value="Öppna om" />
 [% INCLUDE 'csrf-token.inc' %]
 </form>
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="get"><input type="hidden" name="op" value="print" /><input type="hidden" name="basketgroupid" value="[% basketgroup.id | html %]" /><input class="btn btn-primary" type="submit" value="Exportera som PDF" /></form>
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="get"><input type="hidden" name="op" value="export" /><input type="hidden" name="basketgroupid" value="[% basketgroup.id | html %]" /><input class="btn btn-primary" type="submit" value="Exportera som CSV" /></form>
 [% IF Koha.Preference('EDIFACT') %]
 [% IF (ediaccount) %]
 <form action="/cgi-bin/koha/acqui/basketgroup.pl" method="post"><input type="hidden" name="op" value="cud-ediprint" /><input type="hidden" name="basketgroupid" value="[% basketgroup.id | html %]" /><input type="hidden" name="booksellerid" value="[% basketgroup.booksellerid | html %]" /><input class="btn btn-primary" type="submit" value="Skapa EDIFACT-beställning" />
 [% INCLUDE 'csrf-token.inc' %]
 </form>
 [% ELSE %]
 <div>Ingen EDIFACT konfiguration för [% booksellername | html %]</div>
 [% END %]
 [% END %]
 </td>
 </tr>
 [% END %]
 [% END %]
 </tbody>
 </table>
 [% END #/closed %]
 [% END # /WRAPPER tab_panels %]
 [% END # /#basket_groups %]
 [% END %]
 </main>
 </div> <!-- /.col-md-10.order-md-2 -->

 <div class="col-md-2 order-sm-2 order-md-1">
 <aside>
 [% IF ( booksellerid ) %]
 [% INCLUDE 'vendor-menu.inc' %]
 [% END %]
 [% INCLUDE 'acquisitions-menu.inc' %]
 </aside>
 </div>
 </div> <!-- /.row -->

[% MACRO jsinclude BLOCK %]
 [% INCLUDE 'datatables.inc' %]
 <script>
        function submitForm(form) {
            if (form.closedbg.checked == true) {
                var input = document.createElement("input");
                input.setAttribute("type", "hidden");
                input.setAttribute("name", "closed");
                input.setAttribute("value", "1");
                form.appendChild(input);
            }
            form.submit();
        }

        function closeandprint(bg){
            if(document.location = '/cgi-bin/koha/acqui/basketgroup.pl?op=closeandprint&amp;basketgroupid=' + bg ){
                setTimeout("window.location.reload();", 3000);
            } else {
                alert( _("Fel vid nedladdning av fil") );
            }
        }

        $(document).ready(function() {
            [% IF ( listclosed) %]
                $("#basket_groups a[href='#closed']").tab("show");
            [% ELSE %]
                $("#basket_groups a[href='#opened']").tab("show");
            [% END %]
            [% UNLESS ( grouping ) %]
                $("table").dataTable($.extend(true, {}, dataTablesDefaults, {
                    "columnDefs": [
                        { "targets": [ -1 ], "orderable": false, "searchable":  false },
                    ],
                    "autoWidth": false,
                    "pagingType": "full"
                } ));
            [% ELSE %]
                grouped = $("#grouped").DataTable($.extend(true, {}, dataTablesDefaults, {
                    "dom": 't',
                    "columnDefs": [
                        { 'sortable': false, 'targets': [ 'NoSort' ] }
                    ],
                    'autoWidth': false,
                    "language": {
                        "emptyTable": _("Det finns inga korgar i denna grupp")
                    }
                } ));
                ungrouped = $("#ungrouped").DataTable($.extend(true, {}, dataTablesDefaults, {
                    "dom": 't',
                    "columnDefs": [
                        { 'sortable': false, 'targets': [ 'NoSort' ] }
                    ],
                    'autoWidth': false,
                    "language": {
                        "emptyTable": _("Det finns inga ogrupperade korgar")
                    }
                } ));
            [% END %]

            $("#basketgroupcolumns").on("click", ".addtogroup", function(){
                const row = $("#" + $(this).data("basketid") );
                if( row ){
                    $(this).removeClass("addtogroup").addClass("removefromgroup").html("<i class=\"fa fa-trash-can\" aria-hidden=\"true\"></i> " + _("Ta bort") );
                    row.removeClass("ungrouped").addClass("grouped");
                    ungrouped.row( row ).remove().draw();
                    grouped.row.add( row ).draw();
                }
            });

            $("#basketgroupcolumns").on("click", ".removefromgroup", function(){
                const row = $("#" + $(this).data("basketid") );
                if( row ){
                    $(this).removeClass("removefromgroup").addClass("addtogroup").html("<i class=\"fa fa-plus\" aria-hidden=\"true\"></i> " + _("Lägg till i grupp") );
                    $(this).removeClass("").addClass("");
                    row.removeClass("grouped").addClass("ungrouped");
                    grouped.row( row ).remove().draw();
                    ungrouped.row.add( row ).draw();
                }
            });

            $("#close_and_print").on("click", function(e){
                e.preventDefault();
                const basketgroupid = $(this).data("basketgroupid");
                closeandprint( basketgroupid );
            });

            $("#groupingform").on("submit", function(e){
                e.preventDefault();
                submitForm(this);
            });

            $("#delete_basketgroup").on("click", function(e){
                return confirm(_("Är du säker på att du vill ta bort korggruppen?"));
            });
        });
    </script>
[% END %]
[% INCLUDE 'intranet-bottom.inc' %]
